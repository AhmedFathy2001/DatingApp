<div class="card">
  <div class="card-body">
    <div *ngIf="messages.length === 0">
      No messages yet... say hi by using the message box below!
    </div>

    <ul #chat *ngIf="messages.length > 0" class="chat">
      <li *ngFor="let message of messages">
        <div>
          <span class="chat-img float-end">
            <img
              [src]="message.senderPhotoUrl || './assets/user.png'"
              alt="image of the user"
              class="rounded-circle"
            />
          </span>
          <div
            [id]="'id' + message.id.toString()"
            [ngClass]="{ highlight: 'id' + message.id.toString() === fragment }"
            class="chat-body"
          >
            <div class="header">
              <small class="text-muted">
                <span>
                  <fa-icon [icon]="faClock"></fa-icon>
                  {{ message.messageSent + "Z" | timeago }}
                </span>
                <span
                  *ngIf="
                    !message.dateRead && message.senderUsername !== username
                  "
                  class="text-danger"
                >
                  (unread)
                </span>
                <span
                  *ngIf="
                    message.dateRead && message.senderUsername !== username
                  "
                  class="text-success"
                >
                  (read {{ message.dateRead + "Z" | timeago }})
                </span>
              </small>
            </div>
            <p *ngIf="message.content">{{ message.content }}</p>
            <div
              (click)="
                openModal(
                  template,
                  message.mediaUrl,
                  message.messageType,
                  message.content
                )
              "
              *ngIf="message.messageType != 0 && message.mediaUrl"
              class="message-media"
            >
              <div *ngIf="message.messageType == 1 && message.mediaUrl">
                <img [src]="message.mediaUrl" alt="user generated media" />
              </div>
              <div
                *ngIf="message.messageType == 2 && message.mediaUrl"
                class="message-media-video"
              >
                <fa-icon [icon]="faCirclePlay" class="play-icon"></fa-icon>
                <video [src]="message.mediaUrl"></video>
              </div>
            </div>
          </div>
        </div>
      </li>
    </ul>
  </div>
  <div class="card-footer">
    <div
      (click)="
        openModal(
          template,
          mediaFile.toString(),
          file.type.split('/')[0] === 'image' ? 1 : 2,
          content
        )
      "
      *ngIf="mediaFile && file"
      class="send-media-preview"
    >
      <div class="media-preview">
        <div (click)="clearMedia()" class="close-button">x</div>
        <img
          *ngIf="file.type.split('/')[0] === 'image'"
          [src]="mediaFile"
          alt=""
        />
        <video
          *ngIf="file.type.split('/')[0] === 'video'"
          [src]="mediaFile"
        ></video>
      </div>

      (click to preview)
    </div>

    <form #messageForm="ngForm" (ngSubmit)="sendMessage()">
      <div class="input-group">
        <div class="image-upload">
          <label
            (onFileDrop)="addToQueue($event)"
            (onFileSelected)="addToQueue($event)"
            class="form-control"
            for="file-input"
            ng2FileDrop
            ng2FileSelect
          >
            <fa-icon [icon]="faImage"></fa-icon>
          </label>

          <input
            (change)="addToQueue($event)"
            id="file-input"
            name="file-input"
            ng2FileDrop
            ng2FileSelect
            type="file"
          />
        </div>
        <input
          [(ngModel)]="content"
          [required]="file != undefined"
          class="form-control input-sm"
          name="content"
          placeholder="Send a private message"
          type="text"
        />
        <div class="input-group-append">
          <button
            [disabled]="
              ((content && content.trim().length === 0) || !content) &&
              file == undefined
            "
            [ngClass]="{
              disabled:
                ((content && content.trim().length === 0) || !content) &&
                file == undefined
            }"
            class="btn btn-primary"
            type="submit"
          >
            Send
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<ng-template #template>
  <div class="modal-header">
    <h4 class="modal-title pull-left">
      {{ openedFileType === 1 ? "Image Viewer" : "Video Viewer" }}
    </h4>
    <button
      (click)="modalRef?.hide()"
      aria-label="Close"
      class="btn-close close pull-right"
      type="button"
    >
      <span aria-hidden="true" class="visually-hidden">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="modal-body">
      <div *ngIf="openedFileType != 0" class="message-media-modal">
        <div *ngIf="openedFileType == 1 && openedFileSrc">
          <img [src]="openedFileSrc" alt="user generated media" />
        </div>
        <div
          *ngIf="openedFileType == 2 && openedFileSrc"
          class="message-media-video"
        >
          <video [src]="openedFileSrc" autoplay controls></video>
        </div>
      </div>
    </div>
    <div
      *ngIf="openedFileContent"
      class="modal-footer text-start justify-content-start"
    >
      <p>{{ openedFileContent }}</p>
    </div>
  </div>
</ng-template>
